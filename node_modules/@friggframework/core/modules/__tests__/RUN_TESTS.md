# Quick Start - Running Multi-Step Authorization Tests

## Prerequisites

```bash
cd /Users/sean/Documents/GitHub/frigg/packages/core
npm install
```

## Run All Tests

```bash
# Run complete test suite
npm test modules/__tests__

# Expected output:
# PASS  modules/__tests__/unit/domain/authorization-session.test.js
# PASS  modules/__tests__/unit/use-cases/start-authorization-session.test.js
# PASS  modules/__tests__/unit/use-cases/process-authorization-step.test.js
# PASS  modules/__tests__/unit/use-cases/get-authorization-requirements.test.js
# PASS  modules/__tests__/integration/multi-step-auth.test.js
#
# Test Suites: 5 passed, 5 total
# Tests:       85+ passed, 85+ total
```

## Run Specific Test Suites

### Unit Tests Only
```bash
npm test modules/__tests__/unit
```

### Integration Tests Only
```bash
npm test modules/__tests__/integration
```

### Single File
```bash
# Test session creation
npm test modules/__tests__/unit/use-cases/start-authorization-session.test.js

# Test step processing
npm test modules/__tests__/unit/use-cases/process-authorization-step.test.js

# Test complete flows
npm test modules/__tests__/integration/multi-step-auth.test.js
```

## Development Mode

### Watch Mode
```bash
# Auto-run tests on file changes
npm test -- --watch modules/__tests__
```

### Coverage Report
```bash
# Generate coverage report
npm test -- --coverage modules/__tests__

# View detailed HTML report
open coverage/lcov-report/index.html
```

### Verbose Output
```bash
# See all test names and results
npm test -- --verbose modules/__tests__
```

## Expected Test Results

### Domain Entity Tests (25+ tests)
```
âœ“ should create a valid session with all required fields
âœ“ should use default values for optional fields
âœ“ should throw error when sessionId is missing
âœ“ should advance to next step
âœ“ should merge new step data with existing data
âœ“ should mark session as completed
âœ“ should return false for non-expired session
âœ“ should handle single-step sessions
... and 17 more
```

### Use Case Tests (45+ tests)
```
StartAuthorizationSessionUseCase (20+ tests)
  âœ“ should create a new authorization session
  âœ“ should generate unique session IDs
  âœ“ should set expiration to 15 minutes
  ... and 17 more

ProcessAuthorizationStepUseCase (15+ tests)
  âœ“ should process step 1 and return next step
  âœ“ should advance session step after processing
  âœ“ should complete flow on final step
  ... and 12 more

GetAuthorizationRequirementsUseCase (10+ tests)
  âœ“ should return requirements for step 1
  âœ“ should detect multi-step modules
  ... and 8 more
```

### Integration Tests (15+ tests)
```
Multi-Step Authorization Flow - Integration
  Nagaris 2-Step OTP Flow
    âœ“ should complete full OTP authentication flow
    âœ“ should preserve data between steps
    âœ“ should reject invalid OTP
  
  HubSpot Single-Step OAuth Flow
    âœ“ should complete single-step OAuth flow
  
  Slack 2-Step OAuth + Selection Flow
    âœ“ should complete OAuth followed by workspace selection
  
  Session Management
    âœ“ should allow restarting from step 1
    âœ“ should expire sessions after timeout
    âœ“ should enforce user ownership
    âœ“ should prevent skipping steps
  
  ... and 6 more
```

## Troubleshooting

### "Cannot find module" Errors

Make sure dependencies are installed:
```bash
cd /Users/sean/Documents/GitHub/frigg/packages/core
npm install
```

### Test Timeouts

Some integration tests may need more time:
```bash
# Increase timeout (default is 5s)
npm test -- --testTimeout=10000 modules/__tests__
```

### Clear Jest Cache

If tests behave unexpectedly:
```bash
npm test -- --clearCache
npm test modules/__tests__
```

### Debug Specific Test

```bash
# Run with Node debugger
node --inspect-brk node_modules/.bin/jest modules/__tests__/unit/use-cases/start-authorization-session.test.js
```

## Test File Locations

```
modules/__tests__/
â”œâ”€â”€ helpers/
â”‚   â””â”€â”€ auth-test-helpers.js              â† Shared test utilities
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ authorization-session.test.js  â† Domain entity tests
â”‚   â””â”€â”€ use-cases/
â”‚       â”œâ”€â”€ start-authorization-session.test.js
â”‚       â”œâ”€â”€ process-authorization-step.test.js
â”‚       â””â”€â”€ get-authorization-requirements.test.js
â”œâ”€â”€ integration/
â”‚   â””â”€â”€ multi-step-auth.test.js           â† End-to-end flow tests
â”œâ”€â”€ README.md                              â† Full documentation
â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md              â† Summary of what was built
â””â”€â”€ RUN_TESTS.md                          â† This file
```

## Next Steps

After running tests successfully:

1. **Review test coverage**:
   ```bash
   npm test -- --coverage modules/__tests__
   ```

2. **Add missing tests** (see TODO in IMPLEMENTATION_SUMMARY.md):
   - ReauthorizeEntity use case
   - Credential management integration
   - Entity re-authentication integration

3. **Run in CI/CD**:
   - Add to GitHub Actions workflow
   - Add to pre-commit hooks
   - Add to deployment pipeline

## Quick Commands Reference

| Command | Purpose |
|---------|---------|
| `npm test modules/__tests__` | Run all tests |
| `npm test modules/__tests__/unit` | Unit tests only |
| `npm test modules/__tests__/integration` | Integration tests only |
| `npm test -- --watch modules/__tests__` | Watch mode |
| `npm test -- --coverage modules/__tests__` | Coverage report |
| `npm test -- --verbose modules/__tests__` | Verbose output |
| `npm test -- --clearCache` | Clear Jest cache |

## Additional Resources

- [Full Test Documentation](./README.md)
- [Implementation Summary](./IMPLEMENTATION_SUMMARY.md)
- [Test Helpers Guide](./helpers/auth-test-helpers.js)
- [Jest Documentation](https://jestjs.io/docs/getting-started)

---

**Happy Testing!** ğŸ§ª
